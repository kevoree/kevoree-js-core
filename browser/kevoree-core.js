!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("KevoreeLibrary")):"function"==typeof define&&define.amd?define(["KevoreeLibrary"],t):"object"==typeof exports?exports.KevoreeCore=t(require("KevoreeLibrary")):e.KevoreeCore=t(e.KevoreeLibrary)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){(function(t){"use strict";function n(e,t,r){if(!e||!t||!r)throw new Error("KevoreeCore constructor needs a KevScript engine, modulesPath and a KevoreeLogger");this.log=r,this.kevs=e,this.stopping=!1,this.currentModel=null,this.deployModel=null,this.nodeName=null,this.nodeInstance=null,this.modulesPath=t,this.bootstrapper=null,this.firstBoot=!0,this.scriptQueue=[],this.emitter=new s}var o=r(2),i=r(3),s=r(6).EventEmitter,u=/^[\w]+$/;i.inherits(n,s),n.prototype.start=function(e){if(e&&0!==e.length||(e="node0"),!e.match(u))throw new Error("Platform node name must match this regex "+u.toString());this.nodeName=e;var t=new o.factory.DefaultKevoreeFactory;this.currentModel=t.createContainerRoot(),t.root(this.currentModel);var r=t.createContainerNode();r.name=this.nodeName,r.started=!1,this.currentModel.addNodes(r);var n=setInterval(function(){},1e11);this.emitter.on("stopped",function(){clearInterval(n),this.emit("stopped")}.bind(this)),this.log.info(this.toString(),"Platform node name: "+e)},n.prototype.stop=function(){var e=new o.factory.DefaultKevoreeFactory,t=e.createModelCloner(),r=t.clone(this.currentModel,!1),n=r.findNodesByID(this.nodeName);if(n.started){n.started=!1;for(var i=n.hosts.iterator();i.hasNext();)i.next().delete();for(var s=n.groups.iterator();s.hasNext();)s.next().delete();for(var u=r.mBindings.iterator();u.hasNext();){var a=u.next();a.port.eContainer()&&a.port.eContainer().eContainer()&&a.port.eContainer().eContainer().name===n.name&&a.hub&&a.hub.delete()}for(var c=n.components.iterator();c.hasNext();)c.next().delete();this.stopping=!0,this.deploy(r,function(){null===this.nodeInstance?(this.log.info(this.toString(),"Platform stopped before bootstrapped"),this.emitter.emit("stopped")):(this.log.info(this.toString(),"Platform stopped: "+this.nodeInstance.getName()),this.emitter.emit("stopped"))}.bind(this))}else this.emitter.emit("stopped")},n.prototype.deploy=function(e,r){if(r=r||function(){},this.deployModel)this.log.warn(this.toString(),"New deploy process requested: aborted because another one is in process (retry later?)"),r(new Error("New deploy process requested: aborted because another one is in process (retry later?)"));else if(this.emit("deploying",e),e&&!e.findNodesByID(this.nodeName))r(new Error("Deploy model failure: unable to find "+this.nodeName+" in given model"));else{this.log.debug(this.toString(),"Deploy process started...");var n=(new Date).getTime();if(e){var i=this;this.checkBootstrapNode(e,function(s){if(s)i.emit("error",s),r(s);else if(i.nodeInstance){var u,a;try{var c=new o.factory.DefaultKevoreeFactory,l=c.createModelCloner();i.deployModel=l.clone(e,!0),i.deployModel.setRecursiveReadOnly();var p=c.createModelCompare().diff(i.currentModel,i.deployModel);u=i.nodeInstance.processTraces(p,i.deployModel)}catch(e){a=e,i.log.error(i.toString(),a.stack)}var f=[];u.map(function(e){return{type:e.toString(),path:e.modelElement.path(),execute:function(){return new Promise(function(t,r){e.execute(function(e){e?r(e):t()})})},undo:function(){return new Promise(function(t,r){e.undo(function(e){e?r(e):t()})})}}}).reduce(function(e,t,r,n){return e.then(function(){return r>0&&f.unshift(n[r-1]),t.execute()})},Promise.resolve()).then(function(){i.currentModel=e,i.deployModel=null,i.log.info(i.toString(),(i.stopping?"Stop model":"Model")+" deployed successfully: "+u.length+" adaptations ("+((new Date).getTime()-n)+"ms)"),i.processScriptQueue(),i.emit("deployed"),i.firstBoot=!1,r()}).catch(function(e){e.message="Something went wrong while executing adaptations.\n"+e.message,i.log.error(i.toString(),e.stack),i.firstBoot?(i.log.warn(i.toString(),"Shutting down Kevoree because first deployment failed..."),i.deployModel=null,i.stop(),t.nextTick(function(){r(e)})):f.reduce(function(e,t){return e.then(function(){return t.undo()})},Promise.resolve()).then(function(){i.log.info(i.toString(),"Rollback succeed: "+f.length+" adaptations ("+((new Date).getTime()-n)+"ms)"),i.deployModel=null,i.emit("rollbackSucceed"),r()}).catch(function(e){e.message="Something went wrong while rollbacking. Process will exit.\n"+e.message,i.log.error(i.toString(),e.stack),i.deployModel=null,i.stop(),r(e)})})}else r(new Error("There is no instance to bootstrap on"))})}else r(new Error("Model is not defined or null. Deploy aborted."))}},n.prototype.submitScript=function(e,t){var r=this;"function"!=typeof t&&(t=function(e){e&&r.log.error(r.toString(),e.message)}),null===this.deployModel?this.kevs.parse(e,this.currentModel,function(e,n){if(e){var o=new Error("KevScript submission failed ("+e.message+")");return void t(o)}var i,s,u;i=function(){r.off("error",s),r.off("adaptationError",u),t()},s=function(e){r.off("deployed",i),r.off("adaptationError",u);var n=new Error("KevScript submission failed ("+e.message+")");t(n)},u=function(e){r.off("error",s),r.off("deployed",i);var n=new Error("KevScript submission failed ("+e.message+")");t(n)},r.once("deployed",i),r.once("error",s),r.once("adaptationError",u),r.deploy(n)}):(this.scriptQueue.push({script:e,callback:t}),this.log.debug(this.toString(),"Script added to queue at position "+this.scriptQueue.length-1))},n.prototype.processScriptQueue=function(){var e=this;if(this.scriptQueue.length>0){var t=this.scriptQueue[0];this.scriptQueue.splice(0,1),this.log.debug(this.toString(),"Core.processScriptQueue parsing "+t.script),this.kevs.parse(t.script,this.currentModel,function(r,n){if(r){var o=new Error("KevScript submission failed ("+r.message+")");t.callback(o)}else{var i,s,u;i=function(){e.off("error",s),e.off("adaptationError",u),t.callback()},s=function(r){e.off("deployed",i),e.off("adaptationError",u);var n=new Error("KevScript submission failed ("+r.message+")");t.callback(n)},u=function(r){e.off("error",s),e.off("deployed",i);var n=new Error("KevScript submission failed ("+r.message+")");t.callback(n)},e.once("deployed",i),e.once("error",s),e.once("adaptationError",u),e.deploy(n)}})}},n.prototype.checkBootstrapNode=function(e,t){if(!t)throw new Error("No callback defined for checkBootstrapNode(model, cb) in KevoreeCore");if(this.bootstrapper){var r=this;this.nodeInstance?t():(this.log.debug(this.toString(),"Start '"+this.nodeName+"' bootstrapping..."),this.bootstrapper.bootstrapNodeType(this.nodeName,e,function(n,i){if(n)t(n);else{var s;try{var u=e.findNodesByID(r.nodeName),a=r.currentModel.findNodesByID(r.nodeName);r.nodeInstance=new i(r,u,r.nodeName);var c=new o.factory.DefaultKevoreeFactory;a.dictionary=c.createDictionary().withGenerated_KMF_ID("0"),u.typeDefinition.dictionaryType&&u.typeDefinition.dictionaryType.attributes.array.forEach(function(e){if(!e.fragmentDependant){var t=c.createValue();t.name=e.name,t.value=e.defaultValue,a.dictionary.addValues(t),r.log.debug(r.toString(),"Set default node param: "+t.name+"="+t.value)}})}catch(e){s=e}t(s)}}))}else t(new Error("No bootstrapper given to this core. Did you set one?"))},n.prototype.toString=function(){return"Core"},n.prototype.getBootstrapper=function(){return this.bootstrapper},n.prototype.setBootstrapper=function(e){this.bootstrapper=e},n.prototype.getModulesPath=function(){return this.modulesPath},n.prototype.getCurrentModel=function(){return this.currentModel},n.prototype.getLastModel=function(){return"undefined"!=typeof this.deployModel&&null!==this.deployModel?this.deployModel:this.currentModel},n.prototype.getDeployModel=function(){return this.deployModel},n.prototype.getNodeName=function(){return this.nodeName},n.prototype.getLogger=function(){return this.log},n.prototype.off=function(e,t){this.removeListener(e,t)},e.exports=n}).call(t,r(1))},function(e,t){function r(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function o(e){if(l===setTimeout)return setTimeout(e,0);if((l===r||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function i(e){if(p===clearTimeout)return clearTimeout(e);if((p===n||!p)&&clearTimeout)return p=clearTimeout,clearTimeout(e);try{return p(e)}catch(t){try{return p.call(null,e)}catch(t){return p.call(this,e)}}}function s(){y&&d&&(y=!1,d.length?h=d.concat(h):v=-1,h.length&&u())}function u(){if(!y){var e=o(s);y=!0;for(var t=h.length;t;){for(d=h,h=[];++v<t;)d&&d[v].run();v=-1,t=h.length}d=null,y=!1,i(e)}}function a(e,t){this.fun=e,this.array=t}function c(){}var l,p,f=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:r}catch(e){l=r}try{p="function"==typeof clearTimeout?clearTimeout:n}catch(e){p=n}}();var d,h=[],y=!1,v=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];h.push(new a(e,t)),1!==h.length||y||o(u)},a.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=c,f.addListener=c,f.once=c,f.off=c,f.removeListener=c,f.removeAllListeners=c,f.emit=c,f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(t,r){t.exports=e},function(e,t,r){(function(e,n){function o(e,r){var n={seen:[],stylize:s};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),y(r)?n.showHidden=r:r&&t._extend(n,r),_(n.showHidden)&&(n.showHidden=!1),_(n.depth)&&(n.depth=2),_(n.colors)&&(n.colors=!1),_(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=i),a(n,e,n.depth)}function i(e,t){var r=o.styles[t];return r?"["+o.colors[r][0]+"m"+e+"["+o.colors[r][1]+"m":e}function s(e,t){return e}function u(e){var t={};return e.forEach(function(e,r){t[e]=!0}),t}function a(e,r,n){if(e.customInspect&&r&&N(r.inspect)&&r.inspect!==t.inspect&&(!r.constructor||r.constructor.prototype!==r)){var o=r.inspect(n,e);return b(o)||(o=a(e,o,n)),o}var i=c(e,r);if(i)return i;var s=Object.keys(r),y=u(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(r)),M(r)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return l(r);if(0===s.length){if(N(r)){var v=r.name?": "+r.name:"";return e.stylize("[Function"+v+"]","special")}if(S(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(E(r))return e.stylize(Date.prototype.toString.call(r),"date");if(M(r))return l(r)}var g="",m=!1,w=["{","}"];if(h(r)&&(m=!0,w=["[","]"]),N(r)){var _=r.name?": "+r.name:"";g=" [Function"+_+"]"}if(S(r)&&(g=" "+RegExp.prototype.toString.call(r)),E(r)&&(g=" "+Date.prototype.toUTCString.call(r)),M(r)&&(g=" "+l(r)),0===s.length&&(!m||0==r.length))return w[0]+g+w[1];if(n<0)return S(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special");e.seen.push(r);var x;return x=m?p(e,r,n,y,s):s.map(function(t){return f(e,r,n,y,t,m)}),e.seen.pop(),d(x,g,w)}function c(e,t){if(_(t))return e.stylize("undefined","undefined");if(b(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}return m(t)?e.stylize(""+t,"number"):y(t)?e.stylize(""+t,"boolean"):v(t)?e.stylize("null","null"):void 0}function l(e){return"["+Error.prototype.toString.call(e)+"]"}function p(e,t,r,n,o){for(var i=[],s=0,u=t.length;s<u;++s)j(t,String(s))?i.push(f(e,t,r,n,String(s),!0)):i.push("");return o.forEach(function(o){o.match(/^\d+$/)||i.push(f(e,t,r,n,o,!0))}),i}function f(e,t,r,n,o,i){var s,u,c;if(c=Object.getOwnPropertyDescriptor(t,o)||{value:t[o]},c.get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),j(n,o)||(s="["+o+"]"),u||(e.seen.indexOf(c.value)<0?(u=v(r)?a(e,c.value,null):a(e,c.value,r-1),u.indexOf("\n")>-1&&(u=i?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n"))):u=e.stylize("[Circular]","special")),_(s)){if(i&&o.match(/^\d+$/))return u;s=JSON.stringify(""+o),s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function d(e,t,r){var n=0,o=e.reduce(function(e,t){return n++,t.indexOf("\n")>=0&&n++,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0);return o>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}function h(e){return Array.isArray(e)}function y(e){return"boolean"==typeof e}function v(e){return null===e}function g(e){return null==e}function m(e){return"number"==typeof e}function b(e){return"string"==typeof e}function w(e){return"symbol"==typeof e}function _(e){return void 0===e}function S(e){return x(e)&&"[object RegExp]"===D(e)}function x(e){return"object"==typeof e&&null!==e}function E(e){return x(e)&&"[object Date]"===D(e)}function M(e){return x(e)&&("[object Error]"===D(e)||e instanceof Error)}function N(e){return"function"==typeof e}function L(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||"undefined"==typeof e}function D(e){return Object.prototype.toString.call(e)}function T(e){return e<10?"0"+e.toString(10):e.toString(10)}function k(){var e=new Date,t=[T(e.getHours()),T(e.getMinutes()),T(e.getSeconds())].join(":");return[e.getDate(),z[e.getMonth()],t].join(" ")}function j(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var O=/%[sdj%]/g;t.format=function(e){if(!b(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(o(arguments[r]));return t.join(" ")}for(var r=1,n=arguments,i=n.length,s=String(e).replace(O,function(e){if("%%"===e)return"%";if(r>=i)return e;switch(e){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(e){return"[Circular]"}default:return e}}),u=n[r];r<i;u=n[++r])s+=v(u)||!x(u)?" "+u:" "+o(u);return s},t.deprecate=function(r,o){function i(){if(!s){if(n.throwDeprecation)throw new Error(o);n.traceDeprecation?console.trace(o):console.error(o),s=!0}return r.apply(this,arguments)}if(_(e.process))return function(){return t.deprecate(r,o).apply(this,arguments)};if(n.noDeprecation===!0)return r;var s=!1;return i};var C,K={};t.debuglog=function(e){if(_(C)&&(C=n.env.NODE_DEBUG||""),e=e.toUpperCase(),!K[e])if(new RegExp("\\b"+e+"\\b","i").test(C)){var r=n.pid;K[e]=function(){var n=t.format.apply(t,arguments);console.error("%s %d: %s",e,r,n)}}else K[e]=function(){};return K[e]},t.inspect=o,o.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},o.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=h,t.isBoolean=y,t.isNull=v,t.isNullOrUndefined=g,t.isNumber=m,t.isString=b,t.isSymbol=w,t.isUndefined=_,t.isRegExp=S,t.isObject=x,t.isDate=E,t.isError=M,t.isFunction=N,t.isPrimitive=L,t.isBuffer=r(4);var z=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];t.log=function(){console.log("%s - %s",k(),t.format.apply(t,arguments))},t.inherits=r(5),t._extend=function(e,t){if(!t||!x(t))return e;for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e}}).call(t,function(){return this}(),r(1))},function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}},function(e,t){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function n(e){return"function"==typeof e}function o(e){return"number"==typeof e}function i(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,r,o,u,a,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(r=this._events[e],s(r))return!1;if(n(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:u=Array.prototype.slice.call(arguments,1),r.apply(this,u)}else if(i(r))for(u=Array.prototype.slice.call(arguments,1),c=r.slice(),o=c.length,a=0;a<o;a++)c[a].apply(this,u);return!0},r.prototype.addListener=function(e,t){var o;if(!n(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,n(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(o=s(this._maxListeners)?r.defaultMaxListeners:this._maxListeners,o&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){this.removeListener(e,r),o||(o=!0,t.apply(this,arguments))}if(!n(t))throw TypeError("listener must be a function");var o=!1;return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var r,o,s,u;if(!n(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(r=this._events[e],s=r.length,o=-1,r===t||n(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(r)){for(u=s;u-- >0;)if(r[u]===t||r[u].listener&&r[u].listener===t){o=u;break}if(o<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(o,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[e],n(r))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?n(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(n(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}}])});